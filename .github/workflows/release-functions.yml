name: Release Functions Packages

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to create for the release (e.g., functions-v1.0.0). Leave empty to auto-generate."
        required: false
        default: ""
  push:
    branches:
      - main
    paths:
      - "functions/**"
      - "deployment/host.json"

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build packages
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          make_zip() {
            local runtime="$1"
            local src_dir="$2"
            local out="dist/${runtime}.zip"
            local tmp
            tmp="$(mktemp -d)"
            cp deployment/host.json "${tmp}/host.json"
            mkdir -p "${tmp}/${src_dir}"
            cp -R "functions/${src_dir}/." "${tmp}/${src_dir}/"
            (cd "${tmp}" && zip -r -q "${GITHUB_WORKSPACE}/${out}" .)
            rm -rf "${tmp}"
          }

          make_zip dotnet DotnetFunction
          make_zip node NodeFunction
          make_zip python PythonFunction
          make_zip powershell PowerShellFunction
          make_zip java JavaFunction

      - name: Ensure release tag (manual runs)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ inputs.release_tag }}"
          if [ -z "${TAG}" ]; then
            TAG="functions-manual-${{ github.run_number }}"
          fi
          git tag "${TAG}"
          git push origin "${TAG}"
          echo "RELEASE_TAG=${TAG}" >> "${GITHUB_ENV}"

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG || github.ref_name }}
          files: dist/*.zip
