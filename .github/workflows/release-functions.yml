name: Release Functions Packages

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag to create for the release (e.g., functions-v1.0.0). Leave empty to auto-generate."
        required: false
        default: ""
  push:
    branches:
      - main
    paths:
      - "functions/**"
      - "deployment/host.json"

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare dist
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y zip
          mkdir -p dist

      - name: Build runtime packages
        shell: bash
        run: |
          set -euo pipefail

          make_zip() {
            local runtime="$1"
            local src_dir="$2"
            local out="dist/${runtime}.zip"
            local tmp
            tmp="$(mktemp -d)"
            cp "functions/${src_dir}/host.json" "${tmp}/host.json"
            mkdir -p "${tmp}/${src_dir}"
            cp -R "functions/${src_dir}/." "${tmp}/${src_dir}/"
            (cd "${tmp}" && zip -r -q "${GITHUB_WORKSPACE}/${out}" .)
            rm -rf "${tmp}"
          }

          make_zip node NodeFunction
          make_zip python PythonFunction
          make_zip powershell PowerShellFunction

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build .NET package
        shell: bash
        run: |
          set -euo pipefail
          (cd functions/DotnetFunction && dotnet publish -c Release -o publish)
          (cd functions/DotnetFunction/publish && zip -r -q "${GITHUB_WORKSPACE}/dist/dotnet.zip" .)

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
          cache: "maven"

      - name: Build Java package
        shell: bash
        run: |
          set -euo pipefail
          (cd functions/JavaFunction && mvn clean package)
          (cd functions/JavaFunction/target/azure-functions/func-bfh-azfperf-java-test-01 \
            && zip -r -q "${GITHUB_WORKSPACE}/dist/java.zip" .)

      - name: Ensure release tag (manual runs)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ inputs.release_tag }}"
          if [ -z "${TAG}" ]; then
            TAG="functions-manual-${{ github.run_number }}"
          fi
          git tag "${TAG}"
          git push origin "${TAG}"
          echo "RELEASE_TAG=${TAG}" >> "${GITHUB_ENV}"

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG || github.ref_name }}
          files: dist/*.zip